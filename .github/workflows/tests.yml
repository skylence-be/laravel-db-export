name: tests

on:
  push:
    paths:
      - '**.php'
      - '.github/workflows/tests.yml'
      - 'phpstan.neon'
      - 'rector.php'
      - 'composer.json'
      - 'composer.lock'
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, fileinfo
          coverage: none

      - name: Install dependencies
        uses: ramsey/composer-install@v3

      - name: Upload vendor
        uses: actions/upload-artifact@v4
        with:
          name: vendor
          path: vendor/
          retention-days: 1

  rector:
    name: Rector
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Download vendor
        uses: actions/download-artifact@v4
        with:
          name: vendor
          path: vendor/

      - name: Fix permissions
        run: chmod +x vendor/bin/*

      - name: Run Rector
        run: ./vendor/bin/rector --dry-run

  pint:
    name: Pint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Download vendor
        uses: actions/download-artifact@v4
        with:
          name: vendor
          path: vendor/

      - name: Fix permissions
        run: chmod +x vendor/bin/*

      - name: Run Pint
        run: ./vendor/bin/pint --test

  phpstan:
    name: PHPStan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Install dependencies
        uses: ramsey/composer-install@v3

      - name: Cache PHPStan results
        uses: actions/cache@v4
        with:
          path: .phpstan.cache
          key: phpstan-${{ hashFiles('src/**/*.php') }}
          restore-keys: phpstan-

      - name: Run PHPStan
        run: vendor/bin/phpstan --error-format=github --memory-limit=1G

  tests:
    name: P${{ matrix.php }} - L${{ matrix.laravel }} - ${{ matrix.stability }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [rector, pint, phpstan]

    strategy:
      fail-fast: false
      matrix:
        php: ['8.4', '8.3', '8.2']
        laravel: ['10.*', '11.*', '12.*']
        stability: [prefer-stable]
        include:
          - laravel: '10.*'
            testbench: ^8.0
          - laravel: '11.*'
            testbench: ^9.0
          - laravel: '12.*'
            testbench: ^10.0
        exclude:
          - php: '8.2'
            laravel: '12.*'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, fileinfo
          coverage: pcov

      - name: Setup problem matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"
          echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

      - name: Install dependencies
        run: |
          composer require "laravel/framework:${{ matrix.laravel }}" --no-interaction --no-update
          composer require "orchestra/testbench:${{ matrix.testbench }}" --dev --no-interaction --no-update
          composer update --${{ matrix.stability }} --prefer-dist --no-interaction

      - name: List installed dependencies
        run: composer show -D

      - name: Execute tests
        run: vendor/bin/pest --ci

  summary:
    name: Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [rector, pint, phpstan, tests]
    if: always()

    steps:
      - name: All checks passed
        if: ${{ needs.rector.result == 'success' && needs.pint.result == 'success' && needs.phpstan.result == 'success' && needs.tests.result == 'success' }}
        run: |
          echo "### All Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Rector: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Pint: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- PHPStan: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: Passed" >> $GITHUB_STEP_SUMMARY

      - name: Some checks failed
        if: ${{ needs.rector.result != 'success' || needs.pint.result != 'success' || needs.phpstan.result != 'success' || needs.tests.result != 'success' }}
        run: |
          echo "### Some Checks Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Rector: ${{ needs.rector.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pint: ${{ needs.pint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- PHPStan: ${{ needs.phpstan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.tests.result }}" >> $GITHUB_STEP_SUMMARY
          exit 1
